<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="keywords" content="github python jupyter spark kubernetes">
<meta name="description" content="Turn a GitHub repo into a collection of interactive notebooks">
<meta property="og:image" content="http://mybinder.org/images/logo-square.png"/>
<title>binder</title>
<link rel="stylesheet" href="{{ static_url('css/shelves.css') }}">
<link rel="stylesheet" href="{{ static_url('css/styles.css') }}">
<link rel="stylesheet" href="{{ static_url('css/spinner.css') }}" type="text/css">
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="{{ static_url('js/jquery.jscrollpane.min.js') }}"></script>
<script type="text/javascript" src="{{ static_url('js/jquery.mousewheel.js') }}"></script>
<link type="text/css" href="{{ static_url('css/jquery.jscrollpane.css') }}" rel="stylesheet" media="all" />
<link rel="icon" sizes="16x16 32x32" href="{{ static_url('favicon.ico')}}?v=2">
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
<body>

	<div class='row' style='margin-top: 50px; margin-bottom: 25px'>
		<a class='simple-link' href='http://mybinder.org'><img class='logo' src="{{ static_url('images/logo.svg') }}"></img></a>
	</div>
	<div class='row'>
		<h1 id='tracker-repo' style='font-size: 26px; margin-bottom: 3px; margin-top: 0px'>build status for <a class='grayed' href="https://github.com/{{ repo }}">{{ repo }}</a></h1>
		<h1 style='font-size: 20px; margin-top: 5px; margin-bottom: 45px; '>click to copy markdown or rst to paste into your README and get badge</h1>
	</div>
	<div class='row'>
		<div class='column-3 prefix-1' id='tracker'>
			<div id='stages' class='box' style='margin: 0 auto; text-align: center; height: 350px'>
				<div class='row' id='tracker-loading' style='display: none; margin-top: 60px'>
					<div class="three-quarters-loader" style='color: white'>
				  		Loading…
					</div>
				</div>
				<div id='not-found' style='display: none'>
					<h2 class='box-message'>Binder could not be found.
					Double check your address, or return <a class='grayed' href='http://mybinder.org'>home</a> and rebuild your Binder.</h2>
				</div>
				<div id='connection-error' style='display: none'>
					<h2 class='box-message'>Error connecting to server. Check system <a class='grayed' href='http://mybinder.org/status'>status</a>, and try later.</h2>
				</div>
				<div id='build-failed' style='display: none'>
					<h2 class='box-message'>Uh oh, your build failed.
					Check the logs, and go <a class='grayed' href='http://mybinder.org'>home</a> to try again.</h2>
				</div>
				<div class='row' id='tracker-progress' style='display: none'>
					<div class='stage row' style='margin-top: 10px'>
						<h1 class='stage-name'>Submitted</h1>
						<hr id='progress' class='progress-init'>
						<div id='circle-submitted' class='circle'></div>
					</div>
					<div class='stage row'>
						<h1 class='stage-name'>Building</h1>
						<div id='circle-building' class='circle'></div>
					</div>
					<div class='stage row'>
						<h1 class='stage-name'>Deployed</h1>
						<div id='circle-deployed' class='circle'></div>
					</div>
				</div>
			</div>
		</div>

		<div class='column-7 suffix-1' style='margin-bottom:50px'>
			<div id='log-box' class='box log-box' style='margin: 0 auto; height: 350px;'>
				<div class='row' id='logs-loading' style='display: none; margin-top: 60px; height: 50px'>
					<div class="three-quarters-loader" style='color: white'>
				  		Loading…
					</div>
				</div>
				<div id='logs' class='logs' style='display: none'>
					<p class='log-text'> </p>
				</div>
				<div id='log-status' style='height: 50px;'>
					<div id="logs-completed" style='display: none; position: absolute;'>
						<div id='circle-small' class='circle-small'></div>
					</div>
					<div class="spinner" id='logs-continuing' style="position: absolute; display: none">
					  <div class="bounce1"></div>
					  <div class="bounce2"></div>
					  <div class="bounce3"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	

</body>

</html>

<script>

var settings = {
	stickToBottom: true,
	maintainPosition: true
};
var pane = $('#logs')
pane.jScrollPane(settings);
var api = pane.data('jsp');
var i = 1;


var repo = "{{ repo }}"
var endpoint = "http://104.197.23.111:8080/apps/" + repo + "/status"
var ws = new WebSocket("ws://104.197.23.111:8080/apps/" + repo + "/logs")

ws.onopen = function(){
 	console.log('ws connection opened')
};

ws.onmessage = function(ev){
	//console.log('got message from websocket')
	var msg = ev.data.split(':')[4]
	//console.log(msg)
 	update_log(msg)
};

ws.onclose = function(ev){
	console.log('closing')
};

var status
var completed = false
init_status()

setInterval( function() 
	{ 
		console.log('updating status')
		if (completed == false) {
			update_status()
		}
	}, 
	2000
);

function init_status() {

	$.ajax(
		{
			method: "GET",
			url: endpoint,
			timeout: 4000,

			// 
			success: function(data) {
				console.log(data)
				$('#tracker-loading').fadeOut(200, function() {
					status = data.build_status
					if (status == "building") {
						$('#tracker-progress').fadeIn(200);
						set_building()
					} else if (status == "completed") {
						$('#tracker-progress').fadeIn(200);
						set_completed()
					} else {
						$('#build-failed').fadeIn(200);
					}
				});
				$('#logs-loading').fadeOut(200, function() {
					console.log(status)
					$('#logs').fadeIn(200)
					if (status == "building") {
						$('#logs-continuing').fadeIn(100)
					} else if (status == "failed") {
						set_logs_completed('failed')
					} else if (status == "completed") {
						set_logs_completed('success')
					} else {
						no_logs()
					}
				})
			},

			// 
			error: function(err) {
				console.log(err)
				if (err.statusText == "Not Found") {
					$('#logs-loading').fadeOut(200, function() {
						$('#logs').fadeIn(200)
						no_logs()
					});
					$('#tracker-loading').fadeOut(200, function() {
						$('#not-found').fadeIn(200);
					});
				} else {
					$('#logs-loading').fadeOut(200, function() {
						$('#logs').fadeIn(200)
						no_logs()
					});
					$('#tracker-loading').fadeOut(200, function() {
						$('#connection-error').fadeIn(200);
					});
				}
			},

			beforeSend: function() {
				$('#tracker-loading').fadeIn(300)
				$('#logs-loading').fadeIn(300)
			}
		}
	)
}

function update_log(content) {
	api.getContentPane().append(
		$("<p class='log-text' style='display:none'/>").fadeIn(200).text(content)
	);
	api.reinitialise();
}

function update_status() {

	$.ajax(
		{
			method: "GET",
			url: endpoint,
			timeout: 2000,

			success: function(data) {
				if (data.build_status == "building") {
					set_building()
				} else if (data.build_status == "completed") {
					set_completed()
					set_logs_completed('success')
				}
			}
		}
	)
}

function set_building() {
	$('#circle-submitted').addClass('circle-success')
	$('#circle-building').addClass('circle-success')
	$('#progress').addClass('progress-building')
}

function set_completed() {
	$('#circle-submitted').addClass('circle-success')
	$('#circle-building').addClass('circle-success')
	$('#circle-deployed').addClass('circle-success')
	$('#progress').removeClass('progress-building')
	$('#progress').addClass('progress-completed')
	completed = true 
}

function set_logs_completed(msg) {
	$('#logs-continuing').fadeOut(50, function() {
		$('#logs-completed').fadeIn(50)
		if (msg == 'success') {
			$('#circle-small').addClass('circle-small-success')
		} else if (msg == 'failure') {
			$('#circle-small').addClass('circle-small-failure')
		} else {
			$('#circle-small').addClass('circle-small-unknown')
		}
		
	})
}

function no_logs() {
	api.getContentPane().append(
		$("<p class='log-text'/>").text('No logs to display, check message on left')
	);
	api.reinitialise();
	set_logs_completed()
}


</script>
